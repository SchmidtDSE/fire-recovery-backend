from typing import Any, Dict, Optional
from dataclasses import dataclass
from enum import Enum
from datetime import datetime


class CommandStatus(Enum):
    """Status of command execution"""

    SUCCESS = "success"
    FAILED = "failed"
    PARTIAL_SUCCESS = "partial_success"


@dataclass
class CommandResult:
    """
    Result of command execution containing status, data, and metadata.

    This standardized result format allows the API layer to handle
    command outcomes consistently without needing to understand
    the specifics of each command's implementation.
    """

    # Execution status
    status: CommandStatus

    # Execution metadata
    job_id: str
    fire_event_name: str
    command_name: str
    execution_time_ms: float
    timestamp: datetime

    # Result data (command-specific)
    data: Optional[Dict[str, Any]] = None

    # Asset URLs generated by the command
    asset_urls: Optional[Dict[str, str]] = None

    # Error information (if status is FAILED)
    error_message: Optional[str] = None
    error_details: Optional[Dict[str, Any]] = None

    # Additional metadata
    metadata: Optional[Dict[str, Any]] = None

    def __post_init__(self) -> None:
        """Validate result after initialization"""
        if not self.job_id:
            raise ValueError("job_id is required")
        if not self.fire_event_name:
            raise ValueError("fire_event_name is required")
        if not self.command_name:
            raise ValueError("command_name is required")
        if self.execution_time_ms < 0:
            raise ValueError("execution_time_ms must be non-negative")

    @classmethod
    def success(
        cls,
        job_id: str,
        fire_event_name: str,
        command_name: str,
        execution_time_ms: float,
        data: Optional[Dict[str, Any]] = None,
        asset_urls: Optional[Dict[str, str]] = None,
        metadata: Optional[Dict[str, Any]] = None,
    ) -> "CommandResult":
        """Create a successful command result"""
        return cls(
            status=CommandStatus.SUCCESS,
            job_id=job_id,
            fire_event_name=fire_event_name,
            command_name=command_name,
            execution_time_ms=execution_time_ms,
            timestamp=datetime.utcnow(),
            data=data,
            asset_urls=asset_urls,
            metadata=metadata,
        )

    @classmethod
    def failure(
        cls,
        job_id: str,
        fire_event_name: str,
        command_name: str,
        execution_time_ms: float,
        error_message: str,
        error_details: Optional[Dict[str, Any]] = None,
        metadata: Optional[Dict[str, Any]] = None,
    ) -> "CommandResult":
        """Create a failed command result"""
        return cls(
            status=CommandStatus.FAILED,
            job_id=job_id,
            fire_event_name=fire_event_name,
            command_name=command_name,
            execution_time_ms=execution_time_ms,
            timestamp=datetime.utcnow(),
            error_message=error_message,
            error_details=error_details,
            metadata=metadata,
        )

    @classmethod
    def partial_success(
        cls,
        job_id: str,
        fire_event_name: str,
        command_name: str,
        execution_time_ms: float,
        data: Optional[Dict[str, Any]] = None,
        asset_urls: Optional[Dict[str, str]] = None,
        error_message: Optional[str] = None,
        error_details: Optional[Dict[str, Any]] = None,
        metadata: Optional[Dict[str, Any]] = None,
    ) -> "CommandResult":
        """Create a partially successful command result"""
        return cls(
            status=CommandStatus.PARTIAL_SUCCESS,
            job_id=job_id,
            fire_event_name=fire_event_name,
            command_name=command_name,
            execution_time_ms=execution_time_ms,
            timestamp=datetime.utcnow(),
            data=data,
            asset_urls=asset_urls,
            error_message=error_message,
            error_details=error_details,
            metadata=metadata,
        )

    def is_success(self) -> bool:
        """Check if command execution was successful"""
        return self.status == CommandStatus.SUCCESS

    def is_failure(self) -> bool:
        """Check if command execution failed"""
        return self.status == CommandStatus.FAILED

    def is_partial_success(self) -> bool:
        """Check if command execution was partially successful"""
        return self.status == CommandStatus.PARTIAL_SUCCESS

    def has_assets(self) -> bool:
        """Check if result contains asset URLs"""
        return self.asset_urls is not None and len(self.asset_urls) > 0

    def get_asset_url(self, asset_name: str) -> Optional[str]:
        """Get specific asset URL by name"""
        if self.asset_urls is None:
            return None
        return self.asset_urls.get(asset_name)

    def add_asset_url(self, asset_name: str, url: str) -> None:
        """Add asset URL to the result"""
        if self.asset_urls is None:
            self.asset_urls = {}
        self.asset_urls[asset_name] = url

    def add_metadata(self, key: str, value: Any) -> None:
        """Add metadata key-value pair"""
        if self.metadata is None:
            self.metadata = {}
        self.metadata[key] = value
